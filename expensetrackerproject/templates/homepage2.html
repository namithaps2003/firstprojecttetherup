{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Monthly Expense Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
   background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    }
    h1 {
      color: #1e40af;
      margin-bottom: 15px;
      text-align: center;
      font-size: 24px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin: 10px 5%;
      gap:10px;
    }
    .add-btn {
      background: #16a34a;
      color: white;
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      text-decoration: none;
    }
    .add-btn:hover { background: #15803d; }

    .months, select {
      margin: 15px 0;
    }
    .months {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .month-btn {
      padding: 8px 12px;
      margin: 4px;
      border: 1px solid #2563eb;
      border-radius: 8px;
      background: white;
      color: #2563eb;
      cursor: pointer;
      font-size:14px;
    }
    .month-btn.active {
      background: #2563eb;
      color: white;
    }

    /* Table styling */
    .table-container {
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #2563eb;
      color: white;
    }
    .action-btn {
      padding: 8px 14px;
      border-radius: 6px;
      color: white;
      text-decoration: none;
      font-weight: 600;
    }
    .update-btn { background-color: #2563eb; }
    .update-btn:hover { background-color: #1e40af; }
    .delete-btn { background-color: #dc2626; }
    .delete-btn:hover { background-color: #b91c1c; }

    /* Dashboard layout */
    .dashboard-container {
      display: flex;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    .dashboard-left, .dashboard-right {
      flex: 1;
      min-width: 300px;
    }
    canvas {
      display: block;
      margin: 20px auto;
      max-width: 100%;
    }
    .summary-section h3 {
      color: #1e3a8a;
      margin-bottom: 10px;
      text-align: center;
    }

    /* Cards for totals */
    .dashboard-summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    
  .dashboard-summary div {
  flex: 0 1 200px;   /* flex-grow:0, flex-shrink:1, flex-basis:200px */
  min-width: 150px;
  max-width: 220px;  /* limit max width */
  text-align: center;
}

    /* Media queries for responsiveness */
    @media(max-width:768px)
    {
      body { margin: 10px; }

      .top-bar { flex-direction: column; align-items: stretch; gap:10px; margin:10px; }

      h1 { font-size:20px; }

      .month-btn { padding: 6px 10px; font-size:13px; }

      .dashboard-container { flex-direction: column; }

      table { min-width: 600px; }
    }
    @media(max-width:480px)
    {
      h1 { font-size:18px; }
      .month-btn { padding: 5px 8px; font-size:12px; }
      table { min-width: 500px; }
    }
    .logo img {
  height: 70px;   /* smaller height for a compact logo */
  width: auto;    /* maintain aspect ratio */
}
  </style>
</head>
<body>
  <div class="logo">
    <img src="{% static 'images/logo.png' %}" alt="Logo" />
  </div>
  <div>
         <a href="{% url 'firsthomepage' %}">Go to homepage</a>
  </div>

  <!-- Year & Month selection -->
  <form method="get">
    <input type="hidden" name="month" value="{{ selected_month }}">
    <label for="year">Select Year:</label>
    <select name="year" id="year" onchange="this.form.submit()">
      {% for y in years %}
        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <div class="months">
      {% for month, num in months %}
        <button type="submit" name="month" value="{{ num }}" 
          class="month-btn {% if num == selected_month %}active{% endif %}">
          {{ month }}
        </button>
      {% endfor %}
    </div>
  </form>

  <h3>Showing Records for {{ month_name }} {{ selected_year }}</h3>

  <div class="dashboard-summary">
    <div style="background:#16a34a; color:white; padding:15px 25px; border-radius:10px; text-align:center;">
      <h4>Total Income</h4>
      <p>‚Çπ{{ total_income }}</p>
    </div>
    <div style="background:#dc2626; color:white; padding:15px 25px; border-radius:10px; text-align:center;">
      <h4>Total Expense</h4>
      <p>‚Çπ{{ total_expense }}</p>
    </div>
    <div style="background:#2563eb; color:white; padding:15px 25px; border-radius:10px; text-align:center;">
      <h4>Total Balance</h4>
      <p>‚Çπ{{ total_balance }}</p>
    </div>
  </div>

  {% if expenses %}
  <div class="table-container">
    <table>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Description</th>
        <th>Income</th>
        <th>Expense</th>
        <th>Balance</th>
        <th>Bill</th> 
        <th colspan="2">Actions</th>
      </tr>
      {% for e in expenses %}
      <tr>
        <td>{{ e.date }}</td>
        <td>{{ e.category }}</td>
        <td>{{ e.description }}</td>
        <td>{{ e.income }} {% if e.income_source %}({{ e.income_source }}){% endif %}</td>
        <td>{{ e.expense }} {% if e.expense_source %}({{ e.expense_source }}){% endif %}</td>
        <td>{{ e.balance }}</td>
        <td>
          {% if e.bill_pdf %}
            <a href="{{ e.bill_pdf.url }}" target="_blank">üìÑ View PDF</a>
          {% else %}
            No Bill
          {% endif %}
        </td>
        <td><a href="{% url 'updateexpense' e.id %}" class="action-btn update-btn">‚úèÔ∏è Update</a></td>
        <td><a href="{% url 'deleteentry' e.id %}" class="action-btn delete-btn">üóëÔ∏è Delete</a></td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <!-- JSON data for charts -->
  {{ income_by_source|json_script:"income-data" }}
  {{ expense_by_source|json_script:"expense-data" }}

  <!-- Dashboard: Left charts, right tables -->
  <div class="dashboard-container">
    <div class="dashboard-left">
      <h3>üí∞ Income by Source</h3>
      <canvas id="incomeChart"></canvas>

      <h3 style="margin-top:40px;">üí∏ Expense by Source</h3>
      <canvas id="expenseChart"></canvas>
    </div>

    <div class="dashboard-right">
      <h3>üí∞ Income by Source</h3>
      <table class="summary-table">
        <tr><th>Source</th><th>Total Income</th></tr>
        {% for item in income_by_source %}
        <tr>
          <td>{{ item.income_source|default:"(Unspecified)" }}</td>
          <td>{{ item.total }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">No income sources this month</td></tr>
        {% endfor %}
      </table>

      <h3 style="margin-top:30px;">üí∏ Expense by Source</h3>
      <table class="summary-table">
        <tr><th>Source</th><th>Total Expense</th></tr>
        {% for item in expense_by_source %}
        <tr>
          <td>{{ item.expense_source|default:"(Unspecified)" }}</td>
          <td>{{ item.total }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">No expense sources this month</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>
  {% else %}
    <p>No records for this month</p>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const incomeData = JSON.parse(document.getElementById('income-data').textContent);
    const expenseData = JSON.parse(document.getElementById('expense-data').textContent);

    const incomeLabels = incomeData.map(i => i.income_source || "Unspecified");
    const incomeValues = incomeData.map(i => i.total);

    const expenseLabels = expenseData.map(e => e.expense_source || "Unspecified");
    const expenseValues = expenseData.map(e => e.total);

    const incomeChart = new Chart(document.getElementById('incomeChart'), {
      type: 'pie',
      data: { labels: incomeLabels, datasets: [{ data: incomeValues, backgroundColor: ['#2563eb','#16a34a','#f59e0b','#d97706','#dc2626','#9333ea'] }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const expenseChart = new Chart(document.getElementById('expenseChart'), {
      type: 'pie',
      data: { labels: expenseLabels, datasets: [{ data: expenseValues, backgroundColor: ['#2563eb','#16a34a','#f59e0b','#d97706','#dc2626','#9333ea'] }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  </script>
</body>
</html>
